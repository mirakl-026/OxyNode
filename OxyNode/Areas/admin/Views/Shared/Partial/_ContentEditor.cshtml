@* Частичное представление для редактора контента*@


<!---------------------------------- News creator ----------------------------------->
<hr>
<button class="edit_panel__button edit_button" type="button">Редактировать</button>
<button class="edit_panel__button preview_button" type="button" disabled>Предпросмотр</button>


<hr>

<section class="news">
</section>
<div class="file_manager">
    <div class="file_manager__window">
        <div class="file_manager__header">

            <form id="form_forImgLoad" name="_loadImageForm" asp-area="admin" asp-controller="ImageManager" asp-action="LoadImage" method="post" enctype="multipart/form-data">
                <label class="download_img" for="loadImageButton">Загрузить изображение</label>
                <input type="file" id="loadImageButton" name="uploadedImage" accept="image/jpg,image/jpeg,image/png,image/gif" style="display: none;">
            </form>


            <div class="file_manager__close">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M13.2138 12L19.3661 4.66641C19.4692 4.54453 19.3825 4.35938 19.2231 4.35938H17.3528C17.2427 4.35938 17.1372 4.40859 17.0645 4.49297L11.9903 10.5422L6.91611 4.49297C6.84579 4.40859 6.74032 4.35938 6.62782 4.35938H4.75751C4.59814 4.35938 4.51142 4.54453 4.61454 4.66641L10.7669 12L4.61454 19.3336C4.59144 19.3608 4.57662 19.394 4.57184 19.4293C4.56706 19.4647 4.57252 19.5006 4.58757 19.533C4.60263 19.5653 4.62664 19.5926 4.65676 19.6117C4.68689 19.6308 4.72185 19.6408 4.75751 19.6406H6.62782C6.73798 19.6406 6.84345 19.5914 6.91611 19.507L11.9903 13.4578L17.0645 19.507C17.1349 19.5914 17.2403 19.6406 17.3528 19.6406H19.2231C19.3825 19.6406 19.4692 19.4555 19.3661 19.3336L13.2138 12Z" fill="black" />
                </svg>
            </div>
        </div>

        <div class="file_manager__body">
        </div>
    </div>
</div>


<script>
    // window.onload = function (){
    //-------------------------- news creator-------------------------------------
    // edit_panel

    movable = false;        // флаг перемещения

    function create_edit_panel() {
        let edit_panel_dom = document.createElement("div");
        edit_panel_dom.classList = "edit_panel";
        edit_panel_dom.setAttribute("onmousedown", "return false");
        edit_panel_dom.innerHTML = `<div class="edit_panel__move">
        <svg width="24" height="24" viewBox="0 0 24 24">
        <path d="M16,12A2,2 0 0,1 18,10A2,2 0 0,1 20,12A2,2 0 0,1 18,14A2,2 0 0,1 16,12M10,12A2,2 0 0,1 12,10A2,2 0 0,1 14,12A2,2 0 0,1 12,14A2,2 0 0,1 10,12M4,12A2,2 0 0,1 6,10A2,2 0 0,1 8,12A2,2 0 0,1 6,14A2,2 0 0,1 4,12Z" /></svg>
        </div>
        <button class="edit_panel__button add_h3" type="button">Добавить заголовок</button>
        <button class="edit_panel__button add_h4" type="button">Добавить подзаголовок</button>
        <button class="edit_panel__button add_p" type="button">Добавить параграф</button>
        <button class="edit_panel__button add_img" type="button">Добавить картинку</button>
        <button class="edit_panel__button add_video" type="button">Добавить видео</button>
        <button class="edit_panel__button add_author" type="button">Добавить автора</button>
        <button class="edit_panel__button add_date" type="button">Добавить дату</button>
        <button class="edit_panel__button delete_block" type="button">Удалить блок</button>
        <button class="edit_panel__button up_block" type="button">Блок вверх</button>
        <button class="edit_panel__button down_block" type="button">Блок вниз</button>`;

        let news_section = document.querySelector(".news");
        news_section.insertBefore(edit_panel_dom, news_section.firstChild);

        document.querySelector(".add_h3").addEventListener('click', add_h3);
        document.querySelector(".add_h4").addEventListener('click', add_h4);
        document.querySelector(".add_p").addEventListener('click', add_p);
        document.querySelector(".add_img").addEventListener('click', add_img);
        document.querySelector(".add_video").addEventListener('click', add_video);
        document.querySelector(".delete_block").addEventListener('click', delete_block);
        document.querySelector(".up_block").addEventListener('click', up_block);
        document.querySelector(".down_block").addEventListener('click', down_block);

        let edit_panel = document.querySelector(".edit_panel");
        let edit_panel__move = document.querySelector(".edit_panel__move");

        let edit_panel_x = 0,   // положение панели редактирования по Х
            edit_panel_y = 0,       // положение панели редактирования по У
            edit_panel_w = 0,       // ширина панели редактирования в рх
            move_start_x = 0,       // координата начала перемещения по Х
            move_start_y = 0,       // координата начала перемещения по У
            movable = false;        // флаг перемещения

        edit_panel__move.addEventListener('mousedown', movestart);  // по нажатию левой кнопки начало перемещения
        edit_panel__move.addEventListener('mouseup', moveend);      // по отпусканию левой кнопки конец перечещения
        window.addEventListener('mousemove', move);                 // перемещение мыши в окне

        edit_panel_x = edit_panel.getBoundingClientRect().left;     // чтение коорлинаты панели редактирования по Х
        edit_panel_w = edit_panel.getBoundingClientRect().width;    // чтение координаты панели редактирования по У

        if (edit_panel_x < edit_panel_w + 10)    // если координата по Х меньше ширины панели
            edit_panel.style.left = "0px";  // то не двигать панель
        else                                                            // иначе
            edit_panel.style.left = edit_panel_x - edit_panel_w - 10 + "px";  // сдвинуть панель влево на ширину панели
    }

    function movestart() {
        let edit_panel = document.querySelector(".edit_panel");
        movable = true;               // установка флага перемещения панели
        move_start_x = event.clientX; // запомнить координату начала перемещения по Х
        move_start_y = event.clientY; // запомнить координату начала перемещения по У
        edit_panel_x = edit_panel.getBoundingClientRect().left;   // запомнить исходное положение панели редактирования по Х
        edit_panel_y = edit_panel.getBoundingClientRect().top;    // запомнить исходное положение панели редактирования по У
    }

    function moveend() {
        movable = false;  // сброс флага перемещения панели
    }

    function move() {
        let edit_panel = document.querySelector(".edit_panel");
        if (movable) {    // если флаг перемещения установлен
            edit_panel.style.left = (edit_panel_x - (move_start_x - event.clientX)) + "px"; // сдвинуть панель редактирования по Х
            edit_panel.style.top = (edit_panel_y - (move_start_y - event.clientY)) + "px";  // сдвинуть панель редактирования по У
        }
    }



    // news fields

    document.querySelector(".edit_button").addEventListener('click', edit_all)
    document.querySelector(".preview_button").addEventListener('click', preview);
    document.querySelector(".save_button").addEventListener('click', save_all);

    const edit_btn = document.querySelector(".edit_button");
    const preview_btn = document.querySelector(".preview_button");

    function add_h3() {
        const news_field = document.querySelector(".news_field");   // поле с новостью
        let new_textarea = document.createElement('textarea');  // то создать новый блок textarea
        new_textarea.classList = "news__item news__h3";   // с классом взятым из имени кнопки (h3, h4, p)
        new_textarea.placeholder = "Заголовок";
        new_textarea.name = "h3";
        news_field.append(new_textarea);                            // вставить новый блок textarea в поле новости
        new_textarea.addEventListener('focus', new_div);            // добавить прослушку на фокус нового блока textarea
        new_textarea.addEventListener('input', write);              // добавить прослушку на ввод текста в новый блок textarea
        new_textarea.focus();
    }

    function add_h4() {
        const news_field = document.querySelector(".news_field");   // поле с новостью
        let new_textarea = document.createElement('textarea');  // то создать новый блок textarea
        new_textarea.classList = "news__item news__h4";   // с классом взятым из имени кнопки (h3, h4, p)
        new_textarea.placeholder = "Подзаголовок";
        new_textarea.name = "h4";
        news_field.append(new_textarea);                            // вставить новый блок textarea в поле новости
        new_textarea.addEventListener('focus', new_div);            // добавить прослушку на фокус нового блока textarea
        new_textarea.addEventListener('input', write);              // добавить прослушку на ввод текста в новый блок textarea
        new_textarea.focus();
    }

    function add_p() {
        const news_field = document.querySelector(".news_field");   // поле с новостью
        let new_textarea = document.createElement('textarea');  // то создать новый блок textarea
        new_textarea.classList = "news__item news__p";   // с классом параграфа
        new_textarea.placeholder = "Параграф";
        new_textarea.name = "p";
        news_field.append(new_textarea);                            // вставить новый блок textarea в поле новости
        new_textarea.addEventListener('focus', new_div);            // добавить прослушку на фокус нового блока textarea
        new_textarea.addEventListener('input', write);              // добавить прослушку на ввод текста в новый блок textarea
        new_textarea.focus();
    }

    function add_img() {
        let imgs_body = document.querySelector(".file_manager__body");
        imgs_body.innerHTML = "";
        let request = new XMLHttpRequest();
        request.open("GET", "/admin/ImageManager/GetAllImages", false);
        request.send();
        let sources = JSON.parse(request.response);
        for (src of sources) {
            let new_img = document.createElement("div");
            new_img.classList = "file_manager__image";
            new_img.innerHTML = `<img src="` + src + `" alt=""></img>`;
            imgs_body.appendChild(new_img);
        }
        let file_manager = document.querySelector(".file_manager");
        file_manager.classList.add("file_manager_active");
    }

    function add_video() {
        let new_iframe = document.createElement("iframe");
    }

    function delete_block() {
        let focused_item = document.querySelector(".news__item:focus");     // то получить элемент, на котором стоит фокус
        if (focused_item == null) {              // если нет блока с фокусом
            alert("Выбери блок для удаления")   // предупреждение
        }
        else {                      // иначе
            focused_item.remove();  // удалить блок с фокусом
            let old_div = document.querySelector(".news__div"); // получить скрытый блок для блока с фокусом
            if (old_div != null) {   // если он есть
                if (old_div.previousElementSibling != null) // если есть предыдущий блок
                    old_div.previousElementSibling.focus(); // то уставновить на него фокус
                old_div.remove();   // то удалить его
            }
        }
    }

    function up_block() {
        let focused_item = document.querySelector(".news__item:focus");
        if (focused_item == null)
            alert("Блок не выбран");
        else {
            let parent_elem = focused_item.parentElement;
            let prev_elem = focused_item.previousElementSibling;
            if (prev_elem != null) {
                parent_elem.insertBefore(focused_item, prev_elem);
            }
            focused_item.focus();
        }
    }

    function down_block() {
        let focused_item = document.querySelector(".news__item:focus");     // то получить элемент, на котором стоит фокус
        if (focused_item == null)
            alert("Блок не выбран");
        else {
            let parent_elem = focused_item.parentElement;
            if (focused_item.nextElementSibling != null) {
                let next_elem = focused_item.nextElementSibling.nextElementSibling;
                parent_elem.insertBefore(focused_item, next_elem);
                focused_item.focus();
            }
        }
    }

    function new_div() {
        const news_field = document.querySelector(".news_field");   // поле с новостью
        let old_div = document.querySelector(".news__div");             // получить старый скрытый блок
        if (old_div != null) {   // если он получен
            old_div.remove();   // то удалить его
        }
        // console.log(this.classList[this.classList.length - 1]);
        let main_class = this.classList[this.classList.length - 1]; // получить класс для нового скрытого блока (последний в списке классов блока textarea с фокусом)
        let new_div = document.createElement('div');    // создать новый скрытый блок
        new_div.classList = "news__div " + main_class;  // с собственным классом и таким же классом как у teaxtarea с фокусом
        new_div.innerText = this.value; // новому скрытому блоку присвоить значение текста teaxtarea с фокусом
        news_field.append(new_div);     // вставить новый скрытый блок в поле новости
    }


    function write() {   // при вводе в textarea
        let news_div = document.querySelector(".news__div");    // получить скрытый блок
        let value = this.value; // получить текст из textarea
        let new_value = "";     // новая строка для записи
        //------- фильтрация от нескольких пробелов подряд -------//
        for (let i in value) {
            if (new_value.endsWith(" ") && value[i] == " ") { // если новая строка заканчивается на пробел и следующий символ тоже пробел,
                new_value += "&nbsp";
            }                                                 // то ничего не делать
            else                        // иначе
                new_value += value[i];  // добавить следующий символ в новую строку
        }

        this.value = new_value; // переписать текст в textarea
        if ((this.value.endsWith("\n")) | (this.value.endsWith("\n "))) // если нажат enter или enter и пробел 
            news_div.innerText = new_value + "\n";  // то в конец строки добавить \n (чтобы не было пустой строки)
        else                                // иначе
            news_div.innerText = new_value; // вставить новый текст в скрытый блок

        let div_height = news_div.getBoundingClientRect().height;   // получить высоту скрытого блока

        if (div_height > 0) {                        // если высота больше 0
            this.style.height = div_height + "px";  // то присвоить такую же высоту для textarea
        }
        else {                          // иначе
            this.style.height = null;   // сбросить стиль высоты для textarea
        }
    }

    document.querySelector(".file_manager__close").addEventListener('click', function () {
        document.querySelector(".file_manager").classList.remove("file_manager_active");
    });

    document.onclick = function (e) {
        // console.log(event.target.classList[1]);
        if (event.target.classList[1] === "file_manager_active") {
            document.querySelector(".file_manager").classList.remove("file_manager_active");
        }
    }

    function edit_all() {
        create_edit_panel();
        preview_btn.removeAttribute("disabled");
        edit_btn.setAttribute("disabled", "true");

        const news_section = document.querySelector(".news");
        const saved_news = document.querySelector(".saved_news");
        let news_field = document.createElement("div");

        news_field.classList = "news_field";
        news_section.append(news_field);

        if (saved_news != null) {
            const news_items = saved_news.childNodes;
            for (item of news_items) {
                if (item.tagName == "H3") {
                    let new_item = document.createElement("textarea");
                    new_item.classList = item.classList;
                    new_item.value = item.innerText;
                    new_item.name = "h3";
                    new_item.style.height = item.getBoundingClientRect().height + "px";
                    new_item.addEventListener('focus', new_div);            // добавить прослушку на фокус нового блока textarea
                    new_item.addEventListener('input', write);              // добавить прослушку на ввод текста в новый блок textarea           
                    news_field.append(new_item);
                }
                else if (item.tagName == "H4") {
                    let new_item = document.createElement("textarea");
                    new_item.classList = item.classList;
                    new_item.value = item.innerText;
                    new_item.name = "h4";
                    new_item.style.height = item.getBoundingClientRect().height + "px";
                    new_item.addEventListener('focus', new_div);            // добавить прослушку на фокус нового блока textarea
                    new_item.addEventListener('input', write);              // добавить прослушку на ввод текста в новый блок textarea
                    news_field.append(new_item);
                }
                else if (item.tagName == "P") {
                    let new_item = document.createElement("textarea");
                    new_item.classList = item.classList;
                    new_item.value = item.innerText;
                    new_item.name = "p";
                    new_item.style.height = item.getBoundingClientRect().height + "px";
                    new_item.addEventListener('focus', new_div);            // добавить прослушку на фокус нового блока textarea
                    new_item.addEventListener('input', write);              // добавить прослушку на ввод текста в новый блок textarea
                    news_field.append(new_item);
                }
                console.log(item.tagName);
            }

            saved_news.remove();
        }

    }

    function preview() {
        const news_field = document.querySelector(".news_field");   // поле с новостью
        let edit_panel = document.querySelector(".edit_panel");
        edit_panel.remove();

        if (document.querySelector(".news__div") != null)
            document.querySelector(".news__div").remove();

        const news_section = document.querySelector(".news");
        let saved_news = document.createElement("div");
        saved_news.classList = "saved_news";
        news_section.append(saved_news);

        const news_items = news_field.childNodes;
        // console.log(news_items);
        for (item of news_items) {
            if (item.name == "h3") {
                let new_item = document.createElement("h3");
                new_item.classList = item.classList;
                new_item.innerText = item.value;
                saved_news.append(new_item);
            }
            else if (item.name == "h4") {
                let new_item = document.createElement("h4");
                new_item.classList = item.classList;
                new_item.innerText = item.value;
                saved_news.append(new_item);
            }
            else if (item.name == "p") {
                let new_item = document.createElement("p");
                new_item.classList = item.classList;
                new_item.innerText = item.value;
                saved_news.append(new_item);
            }
        }
        for (item of news_items) {
            // console.log(item);
            news_field.remove();
        }
        preview_btn.setAttribute("disabled", true);
        edit_btn.removeAttribute("disabled");
    }

    function save_all() {
        preview();
        let saved_news = document.querySelector(".saved_news");
        document.getElementById("formContent").value = saved_news.innerHTML;
        console.log(document.getElementById("formContent").value);
    }


    // получили форму
    //var form = document.forms._loadImageForm;
    var form = document.getElementById("form_forImgLoad");

    // прикрепляем обработчик кнопки
    document.getElementById("loadImageButton").addEventListener("change", sendRequestImage);

    // обработчик нажатия
    function sendRequestImage(event) {

        event.preventDefault();

        var formData = new FormData(form);

        var request = new XMLHttpRequest();
        request.open("POST", form.action);

        request.send(formData);

        request.onload = function () {
            add_img();
        }
    }





    // window.onbeforeunload = function() {
    //     return "Есть несохранённые изменения. Всё равно уходим?";
    // };

//   } //onload

</script>